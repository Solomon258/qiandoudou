# 全屏闪烁问题调试指南

## 问题现象
剧本视频播放时，点击全屏按钮会出现闪烁现象。

## 修复措施

### 1. 优化视频上下文初始化
- **问题**: 重复初始化视频上下文导致闪烁
- **解决**: 添加条件判断，避免重复创建上下文
- **代码**: 在 `onVideoLoaded` 和 `loadChapterContent` 中检查上下文是否已存在

### 2. 移除可能导致闪烁的属性
- 移除了 `bindtimeupdate` (频繁触发)
- 移除了 `direction` 动态绑定
- 移除了 `show-progress` 等可能导致重渲染的属性
- 移除了视频组件的 `transition` CSS 过渡效果

### 3. 优化全屏状态管理
- 添加状态检查，避免重复设置相同状态
- 在全屏状态变化时管理导航栏显示/隐藏
- 添加页面生命周期管理 (`onShow`, `onHide`)

### 4. 增强错误处理
- 在全屏操作中添加 try-catch 错误处理
- 添加详细的控制台日志用于调试

## 调试步骤

### 1. 开启调试日志
在微信开发者工具的控制台中，你应该能看到以下日志：
```
视频上下文初始化完成
视频加载成功: [视频详情]
当前视频上下文状态: true
当前全屏状态: false
```

### 2. 测试全屏功能
1. 点击视频播放按钮，确保视频正常播放
2. 点击全屏按钮，观察是否还有闪烁
3. 检查控制台是否有 "全屏状态变化" 日志
4. 测试退出全屏功能

### 3. 常见问题排查

#### 如果仍然闪烁：
1. **检查视频 URL**: 确保视频文件可以正常访问
   ```
   http://localhost:8080/api/images/script/古风古情/寻佳缘.mp4
   ```

2. **检查视频格式**: 确保是 MP4 格式，H.264 编码

3. **检查网络**: 确保本地静态服务器正常运行

4. **清除缓存**: 在微信开发者工具中清除缓存重新加载

#### 如果全屏按钮无响应：
1. 检查控制台是否有 "视频上下文未初始化" 错误
2. 尝试重新进入页面
3. 检查视频是否完全加载完成

## 备用解决方案

如果问题仍然存在，可以尝试以下方案：

### 方案1: 使用原生全屏API
```javascript
// 在 requestFullscreen 方法中添加
try {
  // 先尝试微信小程序的方式
  this.data.videoContext.requestFullScreen({ direction: 0 })
} catch (error) {
  // 如果失败，尝试原生方式
  const videoElement = document.querySelector('#chapterVideo')
  if (videoElement && videoElement.requestFullscreen) {
    videoElement.requestFullscreen()
  }
}
```

### 方案2: 简化视频组件
移除所有非必要的属性，只保留基本功能：
```xml
<video id="chapterVideo"
       src="{{chapterContent.videoUrl}}"
       controls="{{true}}"
       show-fullscreen-btn="{{true}}"
       bindfullscreenchange="onFullscreenChange">
</video>
```

### 方案3: 延迟全屏请求
```javascript
requestFullscreen() {
  // 延迟执行全屏请求，避免与其他操作冲突
  setTimeout(() => {
    if (this.data.videoContext) {
      this.data.videoContext.requestFullScreen({ direction: 0 })
    }
  }, 100)
}
```

## 文件修改清单
- ✅ `script-detail.js`: 优化视频上下文管理和全屏事件处理
- ✅ `script-detail.wxml`: 简化视频组件属性，移除可能导致闪烁的绑定
- ✅ `script-detail.wxss`: 移除过渡效果，优化视频显示
- ✅ 添加详细的调试日志

请按照上述步骤测试，如果问题仍然存在，请提供控制台的详细错误信息。
