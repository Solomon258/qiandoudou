<!--pages/home/home.wxml-->
<view class="container">
  <!-- 自定义导航栏 -->
  <view class="custom-nav" style="height:{{navHeight}}px">
    <view class="nav-back" bindtap="onBack">登出</view>
    <view class="nav-title">{{currentTab === 'wallet' ? '钱兜兜' : '兜圈圈'}}</view>
  </view>
  <!-- 钱兜兜页面 -->
  <view wx:if="{{currentTab === 'wallet'}}" class="wallet-page">
    <!-- 顶部导航栏 -->
    <view class="top-nav">
      <!-- <view class="nav-left">
        <view class="back-btn" bindtap="handleLogout">
          <text class="back-arrow">‹</text>
        </view>
        <text class="nav-title">钱兜兜</text>
      </view> -->
      <view class="nav-right">
        <view class="notification-icon-new" bindtap="showNotifications">
          <image class="notification-icon-img" src="https://qiandoudou.oss-cn-guangzhou.aliyuncs.com/res/image/include_images/7AB14F84-3AAF-42E6-9C09-AD1AC9545E14.png" mode="aspectFit"/>
          <view wx:if="{{unreadMessageCount > 0}}" class="unread-badge">
            <text class="unread-count">{{unreadMessageCount > 99 ? '99+' : unreadMessageCount}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 钱兜兜列表 -->
    <view wx:if="{{wallets.length > 0}}" class="wallet-list-section">
      <view wx:for="{{wallets}}" wx:key="id" class="wallet-card" 
            style="{{item.backgroundStyle}}" 
            bindtap="handleWalletTap" 
            data-id="{{item.id}}">
        <!-- 钱兜兜信息 -->
        <view class="wallet-info">
          <view class="wallet-header">
            <text class="wallet-title">{{item.name || '钱兜兜'}}</text>
            <text class="wallet-type">{{item.type === 1 ? '个人' : '情侣'}}</text>
          </view>
          <!-- 分享按钮 -->
          <view class="share-btn" catchtap="onWalletShare" data-wallet="{{item}}">
            <image class="share-icon" src="/static/icon/share.svg" mode="aspectFit"/>
          </view>
          <view class="wallet-amount">
            <text class="amount-text">¥ {{item.balance || '0.00'}}</text>
          </view>
          
          <!-- AI伴侣信息（情侣钱兜兜） -->
          <view wx:if="{{item.type === 2 && item.ai_partner_name}}" class="ai-partner-info">
            <text class="partner-label">AI伴侣：</text>
            <text class="partner-name">{{item.ai_partner_name}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 没有钱兜兜时显示欢迎信息 -->
    <view wx:if="{{wallets.length === 0 && !showWalletTypeModal}}" class="welcome-section">
      <view class="welcome-card">
        <text class="welcome-title">欢迎来到钱兜兜！</text>
        <text class="welcome-desc">开始创建你的第一个钱兜兜吧～</text>
      </view>
    </view>



    <!-- 新建钱兜兜按钮 -->
    <view class="create-wallet-section">
      <view class="create-wallet-card" bindtap="handleCreateWallet">
        <view class="create-content">
          <text class="add-icon">+</text>
          <text class="create-text">新建钱兜兜</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 兜圈圈页面 -->
  <view wx:if="{{currentTab === 'social'}}" class="social-page">
    <!-- 顶部导航栏 -->
    <view class="social-top-nav">
      <!-- <view class="nav-left" bindtap="handleBack">
        <view class="back-icon"></view>
      </view>
      <view class="nav-title">兜圈圈</view> -->
      <view class="nav-right">
        <view class="user-icon-new" bindtap="navigateToUserSocialProfile">
          <image class="user-icon-img" src="https://qiandoudou.oss-cn-guangzhou.aliyuncs.com/res/image/include_images/53EAEFAA-39B8-4E6C-B88C-1DB241C01C23.png" mode="aspectFit"/>
        </view>
        <view class="notification-icon-new" bindtap="showNotifications">
          <image class="notification-icon-img" src="https://qiandoudou.oss-cn-guangzhou.aliyuncs.com/res/image/include_images/7AB14F84-3AAF-42E6-9C09-AD1AC9545E14.png" mode="aspectFit"/>
          <view wx:if="{{unreadMessageCount > 0}}" class="unread-badge">
            <text class="unread-count">{{unreadMessageCount > 99 ? '99+' : unreadMessageCount}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 动态列表 -->
    <scroll-view class="social-posts-scroll" scroll-y="true" bindscrolltolower="loadMorePosts">
      <view wx:if="{{posts.length === 0}}" class="social-empty-state">
        <text class="empty-icon">💬</text>
        <text class="empty-text">还没有动态，快来分享你的理财心得吧！</text>
      </view>

      <view wx:for="{{posts}}" wx:key="id" class="social-post-card" bindtap="goToWalletDetail" data-wallet-id="{{item.wallet_id}}" data-index="{{index}}">
        <!-- 动态卡片背景样式 -->
        <view class="post-bg" style="{{item.backgroundStyle}}"></view>
        
        <!-- 粉丝标签 -->
        <view class="fans-badge">粉丝 {{item.fansCount}}</view>
        
        <!-- 动态内容区域 -->
        <view class="post-content-area">
          <!-- 钱兜兜信息和总金额 -->
          <view class="post-main-header">
            <view class="post_title_view">
              <view class="post-title">{{item.title}}</view>
              <!-- 参与人数 -->
              <view class="participants">{{item.participantCount}}人</view>
            </view>
            <view class="post-amount">¥{{item.total_amount}}</view>
          </view>
          
          <!-- 标签和描述 -->
          <view class="post-tags-desc">
            <text class="tag" wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this">#{{tag}}</text>
            <text class="description">{{item.description}}</text>
          </view>
          
          <!-- 最新两笔账单 -->
          <view class="recent-transactions">
            <view wx:for="{{item.recent_transactions}}" wx:for-item="transaction" wx:key="id" class="transaction-item">
              <view class="transaction-user-avatar">
                <text class="avatar-text">{{transaction.user_nickname.charAt(0)}}</text>
              </view>
              <view class="transaction-content">
                <text class="transaction-desc">{{transaction.user_nickname}}：{{transaction.comment}}</text>
                <text wx:if="{{transaction.amount > 0}}" class="amount-change">+¥{{transaction.amount}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- 加载更多提示 -->
      <view wx:if="{{loadingMore}}" class="loading-more">
        <text class="loading-text">加载中...</text>
      </view>
      
      <view wx:elif="{{!hasMorePosts && posts.length > 0}}" class="no-more-data">
        <text class="no-more-text">没有更多数据了</text>
      </view>
    </scroll-view>
  </view>

  <!-- 底部导航 -->
  <view class="bottom-nav">
    <view class="nav-item {{currentTab === 'wallet' ? 'active' : ''}}" bindtap="switchTab" data-tab="wallet">
      <view class="nav-icon-container">
        <image class="notification-icon-img2" wx:if="{{currentTab === 'wallet'}}" src="/static/icon/qian_active.svg" mode="aspectFit"/>
        <image class="notification-icon-img2"  wx:else src="/static/icon/qiandoudou.svg" mode="aspectFit"/>
      </view>
      <text class="nav-text">钱兜兜</text>
    </view>
    <view class="nav-item {{currentTab === 'social' ? 'active' : ''}}" bindtap="switchTab" data-tab="social">
      <view class="nav-icon-container">
        <image wx:if="{{currentTab === 'social'}}" class="notification-icon-img2" src="/static/icon/douquan_active.svg" mode="aspectFit"/>
        <image wx:else class="notification-icon-img2" src="/static/icon/douquanquan.svg" mode="aspectFit"/>
      </view>
      <text class="nav-text">兜圈圈</text>
    </view>
  </view>

  <!-- 钱兜兜类型选择模态框 -->
  <view wx:if="{{showWalletTypeModal}}" class="modal-overlay" bindtap="hideWalletTypeModal">
    <view class="wallet-type-modal" catchtap="stopPropagation">
      <!-- 模态框头部 -->
      <view class="modal-header">
        <view class="modal-title">
          <text>选择钱兜兜用途</text>
        </view>
        <!-- 只有非首次用户才显示关闭按钮 -->
        <view wx:if="{{!isFirstTimeUser}}" class="modal-close" bindtap="hideWalletTypeModal">
          <text class="close-icon">×</text>
        </view>
      </view>
      
      <!-- 钱兜兜类型选项 -->
      <view class="wallet-type-options">
        <!-- 自己攒钱 -->
        <view class="wallet-type-option {{selectedWalletType === 'personal' ? 'selected' : ''}}" bindtap="selectWalletType" data-type="personal">
          <view class="option-icon couple">
            <image class="couple-avatar-image" src="/static/icon/gerenzan.png" mode="aspectFill"></image>
          </view>
          <view class="option-content">
            <text class="option-title">自己攒钱</text>
            <text class="option-desc">自己攒钱，分类管钱等</text>
          </view>
          <view class="option-radio">
            <view class="radio-circle {{selectedWalletType === 'personal' ? 'selected' : ''}}">
              <text wx:if="{{selectedWalletType === 'personal'}}" class="check-mark">✓</text>
            </view>
          </view>
        </view>
        
        <!-- 情侣攒钱 -->
        <view class="wallet-type-option {{selectedWalletType === 'couple' ? 'selected' : ''}}" bindtap="selectWalletType" data-type="couple">
          <view class="option-icon couple">
            <image class="couple-avatar-image" src="/static/icon/qinglv.png" mode="aspectFill"></image>
          </view>
          <view class="option-content">
            <text class="option-title">情侣攒钱</text>
            <text class="option-desc">和AI伴侣一起攒钱</text>
          </view>
          <view class="option-radio">
            <view class="radio-circle {{selectedWalletType === 'couple' ? 'selected' : ''}}">
              <text wx:if="{{selectedWalletType === 'couple'}}" class="check-mark">✓</text>
            </view>
          </view>
        </view>
        <!-- 情侣攒钱 -->
        <view class="wallet-type-option {{selectedWalletType === 'couple2' ? 'selected' : ''}}" bindtap="selectWalletType" data-type="couple2">
          <view class="option-icon couple">
            <image class="couple-avatar-image" src="/static/icon/dazi.png" mode="aspectFill"></image>
          </view>
          <view class="option-content">
            <text class="option-title">搭子攒钱</text>
            <text class="option-desc">和搭子一起攒钱</text>
          </view>
          <view class="option-radio">
            <view class="radio-circle {{selectedWalletType === 'couple2' ? 'selected' : ''}}">
              <text wx:if="{{selectedWalletType === 'couple2'}}" class="check-mark">✓</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- 确认按钮 -->
      <view class="modal-footer">
        <button class="confirm-create-btn" bindtap="confirmCreateWallet" disabled="{{!selectedWalletType}}">
          <text class="btn-text">确认新建钱兜兜</text>
        </button>
      </view>
    </view>
  </view>

  <!-- 分享弹窗 -->
  <share-modal 
    show="{{showShareModal}}" 
    shareImageUrl="{{shareImageUrl}}"
    bind:close="onShareModalClose"
    bind:save="onShareImageSave">
  </share-modal>
</view>