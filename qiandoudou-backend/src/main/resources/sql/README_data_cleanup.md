# 数据清理脚本使用说明

## 概述
本目录包含用于清理千豆豆项目测试数据的SQL脚本，保留test账号数据，删除其他所有用户相关数据。

## 脚本文件说明

### 1. `update_wallet_public.sql` - 一键执行版本
- **用途**: 直接执行数据清理，适合快速清理测试环境
- **特点**: 包含完整的事务控制和结果验证
- **风险**: 直接执行删除操作，请确保在测试环境使用

### 2. `clean_non_test_data_safe.sql` - 安全预览版本  
- **用途**: 分步执行，先预览再确认删除
- **特点**: 默认只显示预览信息，需要手动取消注释来执行删除
- **推荐**: 首次使用或生产环境清理时推荐使用

## 执行前检查清单

- [ ] **数据库备份**: 已完成数据库完整备份
- [ ] **环境确认**: 确认当前是开发/测试环境，非生产环境  
- [ ] **Test账号确认**: 确认test相关账号存在且需要保留
- [ ] **团队确认**: 已与团队确认此清理操作
- [ ] **权限检查**: 确认有足够的数据库操作权限

## 保留数据规则

脚本将保留以下数据：
- 用户名包含 'test' 的所有用户账号
- 这些test用户的所有关联数据（钱包、交易记录、社交数据等）

## 删除数据范围

将删除以下数据（按删除顺序）：
1. **消息通知** (notifications)
2. **关注关系** (user_follows) 
3. **动态点赞** (post_likes)
4. **动态评论** (post_comments)
5. **社交动态** (social_posts)
6. **用户剧本进度** (user_script_progress)
7. **交易记录** (transactions)
8. **钱包数据** (wallets)
9. **用户数据** (users) - 除test用户外

## 使用方法

### 方法一：使用一键执行版本
```sql
-- 在MySQL客户端中执行
source /path/to/update_wallet_public.sql;
```

### 方法二：使用安全预览版本（推荐）
1. 先执行预览部分：
```sql
source /path/to/clean_non_test_data_safe.sql;
```

2. 检查预览结果，确认无误后，编辑文件取消删除脚本的注释

3. 再次执行完整脚本

### 方法三：分步手动执行
建议按以下顺序逐步执行DELETE语句，每步后检查结果：

```sql
-- 1. 先查看要删除的数据
SELECT COUNT(*) FROM users WHERE username NOT LIKE '%test%';

-- 2. 执行单个删除操作
DELETE FROM notifications WHERE user_id NOT IN (...);

-- 3. 检查删除结果
SELECT ROW_COUNT();
```

## 验证清理结果

执行完成后，脚本会自动显示：
- 剩余的用户列表
- 各表的剩余数据统计
- 执行时间戳

## 注意事项

1. **事务控制**: 脚本使用事务确保数据一致性，如有异常会自动回滚
2. **安全模式**: 暂时关闭MySQL安全模式以允许批量删除
3. **外键约束**: 按照外键依赖关系逆序删除，避免约束冲突
4. **性能考虑**: 大量数据删除可能需要较长时间，请耐心等待

## 常见问题

### Q: 如何恢复误删的数据？
A: 只能通过之前的数据库备份恢复，这就是为什么执行前备份非常重要。

### Q: 可以修改保留条件吗？
A: 可以修改SQL中的 `username LIKE '%test%'` 条件来调整保留规则。

### Q: 执行时间大概多长？
A: 取决于数据量，通常几分钟到几十分钟不等。

### Q: 可以在生产环境使用吗？
A: 强烈不建议在生产环境使用，仅适用于开发和测试环境。

## 联系方式

如有问题请联系开发团队。

---
**最后更新**: 2024年
**版本**: 1.0

