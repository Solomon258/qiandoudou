# 视频缓存和章节切换问题修复说明

## 问题描述

1. **视频缓存问题**：替换同名视频文件后，仍然播放旧文件
2. **章节切换问题**：无法回到第一集

## 修复方案

### 1. 视频缓存问题修复

#### 前端解决方案
- **时间戳参数**：在视频URL后添加时间戳参数 `?v=timestamp`
- **手动清除缓存**：添加了"清除视频缓存"按钮
- **视频状态重置**：切换章节时重置所有视频相关状态

#### 静态服务器优化
- **禁用缓存**：在 `start-static-server.bat` 中添加 `--no-cache` 参数
- **强制刷新**：使用 `-c-1` 参数设置缓存时间为-1

### 2. 章节切换功能修复

#### 逻辑优化
- **状态检查**：添加当前章节检查，避免重复加载
- **选择器更新**：正确更新章节选择器的 `current` 状态
- **解锁验证**：保留章节解锁验证逻辑
- **详细日志**：添加章节切换的调试日志

#### 数据库修复
- **软删除恢复**：修复了第二、三集被误标记为删除的问题
  ```sql
  UPDATE script_chapters SET deleted = 0 WHERE script_id = 1 AND chapter_number IN (2, 3);
  ```

## 使用说明

### 解决视频缓存问题

**方法1：重启静态服务器**
```bash
# 停止当前的静态服务器（Ctrl+C）
# 重新启动
start-static-server.bat
```

**方法2：使用清除缓存按钮**
1. 在视频下方的调试信息区域
2. 点击"清除视频缓存"按钮
3. 视频会自动重新加载

**方法3：微信开发者工具清缓存**
1. 在微信开发者工具中点击"清缓存"
2. 选择"清除全部"
3. 重新编译小程序

### 章节切换功能

现在可以：
- ✅ 点击章节选择器中的任意已解锁章节
- ✅ 从第二集回到第一集
- ✅ 正确显示当前章节状态
- ✅ 保持章节解锁逻辑

## 技术细节

### 防缓存机制
```javascript
// 添加时间戳参数
const timestamp = new Date().getTime()
const separator = videoUrl.includes('?') ? '&' : '?'
videoUrl = videoUrl + separator + 'v=' + timestamp
```

### 章节切换优化
```javascript
// 避免重复加载当前章节
if (chapterNumber === currentChapter) {
  return
}

// 更新章节选择器状态
const updatedChapters = availableChapters.map(ch => ({
  ...ch,
  current: ch.number === chapterNumber
}))
```

## 调试功能

页面现在包含调试信息显示：
- 当前视频URL（含防缓存参数）
- 全屏状态
- 视频上下文初始化状态
- 清除缓存按钮

## 测试步骤

1. **重启后端服务**：`start-backend.bat`
2. **启动静态服务器**：`start-static-server.bat`（注意使用新版本，包含 `--no-cache`）
3. **在微信开发者工具中测试**：
   - 清除缓存并重新编译
   - 进入剧本攒页面
   - 测试章节切换功能
   - 测试视频播放和全屏功能
   - 如果视频仍然是旧版本，点击"清除视频缓存"按钮

## 预期结果

- ✅ 视频播放最新替换的文件
- ✅ 可以在第一集和第二集之间自由切换
- ✅ 全屏功能正常工作，无闪烁
- ✅ 章节选择器正确显示当前章节状态
